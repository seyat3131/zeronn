<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERON ORG. | Scrim Slot Rezervasyon</title>
    <!-- Tailwind CSS (Tek dosya için stil kolaylığı sağlar) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK'ları -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- SENİN FIREBASE AYARLARIN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAW4OMb2p6SIwR3os3smlaYruBAJIHN6eY",
            authDomain: "zeronn-5d734.firebaseapp.com",
            projectId: "zeronn-5d734",
            storageBucket: "zeronn-5d734.firebasestorage.app",
            messagingSenderId: "861103373556",
            appId: "1:861103373556:web:c3cff9215821e912a072a1",
            measurementId: "G-HKB3Z7WFX7"
        };

        // Firebase ve Firestore Servislerini Başlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; // Giriş yapan kullanıcının ID'si
        let currentSlots = {}; // Anlık slot durumu
        let mySlot = null; // Kullanıcının aldığı slot

        // Tarih formatını belirler (Örn: 23.11.2025)
        const getTodayDateString = () => new Date().toLocaleDateString('tr-TR');

        // Sayaç Güncelleme Fonksiyonu
        const updateCountdown = () => {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // Yarın 00:00:00
            
            const diff = tomorrow - now;
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
            const m = Math.floor((diff / (1000 * 60)) % 60).toString().padStart(2, '0');
            const s = Math.floor((diff / 1000) % 60).toString().padStart(2, '0');
            
            document.getElementById('countdown-timer').textContent = `${h}:${m}:${s}`;
        };

        // Slotları çizer ve günceller
        const renderSlots = () => {
            const slotsContainer = document.getElementById('slots-container');
            if (!slotsContainer) return;

            // Başarı mesajını gizle/göster
            const successMessage = document.getElementById('success-message');
            if (mySlot) {
                successMessage.classList.remove('hidden');
                document.getElementById('booked-slot-number').textContent = mySlot;
            } else {
                successMessage.classList.add('hidden');
            }

            // 25 Slotu oluştur
            slotsContainer.innerHTML = Array.from({ length: 25 }, (_, i) => i + 1).map((num) => {
                const slotInfo = currentSlots[num];
                const isTaken = !!slotInfo;
                const isMine = mySlot === num;
                
                let buttonClass = 'bg-neutral-900 border border-neutral-800 text-white cursor-pointer hover:bg-neutral-800 transition';
                let contentHTML = `<span class="text-xs text-neutral-600 mt-1">TIKLA</span>`;

                if (isTaken) {
                    buttonClass = 'bg-neutral-950 border border-neutral-900 text-white cursor-default opacity-50';
                    if (isMine) {
                         buttonClass = 'bg-green-950 border-2 border-green-500 text-white cursor-default';
                         contentHTML = `<span class="text-xs bg-green-700/30 text-green-400 px-2 py-0.5 rounded-md mb-1">SİZİN</span>
                                         <div class="font-bold text-xs uppercase truncate w-full px-1 text-center">${slotInfo.teamName}</div>`;
                    } else {
                         contentHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-600 mb-1"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                        <div class="font-bold text-xs uppercase truncate w-full px-1 text-center">${slotInfo.teamName}</div>`;
                    }
                } else if (mySlot) {
                    // Başka slot alamaz
                    buttonClass = 'bg-neutral-900 border border-neutral-800 text-neutral-700 cursor-default opacity-50';
                }

                return `
                    <button data-slot="${num}" class="slot-button h-24 rounded-xl relative flex flex-col items-center justify-center overflow-hidden ${buttonClass}" ${isTaken || mySlot ? 'disabled' : ''}>
                        <span class="absolute top-1 left-2 text-2xl opacity-5 font-bold">${num}</span>
                        ${isTaken ? '' : `<span class="text-sm font-bold text-neutral-500">SLOT ${num}</span>`}
                        ${contentHTML}
                    </button>
                `;
            }).join('');
            
            // Tıklama olaylarını ekle
            document.querySelectorAll('.slot-button').forEach(button => {
                button.onclick = (e) => {
                    const slotNum = parseInt(e.currentTarget.dataset.slot);
                    if (!e.currentTarget.disabled) {
                        openModal(slotNum);
                    }
                };
            });
        };

        // Slot Kayıt Modalını açar
        const openModal = (slotNum) => {
            document.getElementById('modal-title').textContent = `SLOT ${slotNum} ALINIYOR`;
            document.getElementById('booking-modal').classList.remove('hidden');
            document.getElementById('modal-form').onsubmit = (e) => confirmBooking(e, slotNum);
        };

        // Slot Kayıt Modalını kapatır
        const closeModal = () => {
            document.getElementById('booking-modal').classList.add('hidden');
            document.getElementById('team-name-input').value = '';
            document.getElementById('instagram-input').value = '';
        };

        // Slotu Kaydeder
        const confirmBooking = async (e, slotNum) => {
            e.preventDefault();
            const teamName = document.getElementById('team-name-input').value.trim();
            const instagram = document.getElementById('instagram-input').value.trim();

            if (!teamName || !instagram) return;

            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'LÜTFEN BEKLE...';
            
            try {
                const docId = `${getTodayDateString().replace(/\./g, '-')}-${slotNum}`;
                const docRef = doc(db, 'bookings', docId);
                
                await setDoc(docRef, {
                    slotId: slotNum,
                    teamName: teamName.toUpperCase(),
                    instagram: instagram,
                    userId: currentUser.uid,
                    date: getTodayDateString(),
                    timestamp: Date.now()
                });
                
                closeModal();
            } catch (error) {
                console.error("Kayıt hatası:", error);
                // alert() yerine bu konsola yazdırıldı
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'SLOTU KAPAT';
            }
        };

        // Uygulama Başlangıcı
        document.addEventListener('DOMContentLoaded', () => {
            // Geri Sayımı başlat
            setInterval(updateCountdown, 1000);
            updateCountdown();

            // Anonim giriş yap
            signInAnonymously(auth).catch((err) => console.error("Giriş hatası:", err));
            
            // Kullanıcı durumunu dinle
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    // Firestore dinlemeyi başlat
                    const bookingsRef = collection(db, 'bookings'); 
                    onSnapshot(bookingsRef, (snapshot) => {
                        const todayStr = getTodayDateString();
                        let newSlots = {};
                        let newUserBookedSlot = null;

                        snapshot.docs.forEach((doc) => {
                            const data = doc.data();
                            if (data.date === todayStr) {
                                newSlots[data.slotId] = data;
                                if (data.userId === currentUser.uid) {
                                    newUserBookedSlot = data.slotId;
                                }
                            }
                        });
                        currentSlots = newSlots;
                        mySlot = newUserBookedSlot;
                        renderSlots();
                    });
                } else {
                    renderSlots(); // Kullanıcı yoksa bile slotları boş çiz
                }
            });
            
            // Modal kapatma olayını ayarla
            document.getElementById('close-modal-button').onclick = closeModal;
        });

    </script>
</head>
<body class="bg-[#050505] min-h-screen text-white font-sans">
    
    <!-- ÜST MENÜ (NAVBAR) -->
    <nav class="sticky top-0 z-40 bg-[rgba(10,10,10,0.95)] border-b border-neutral-800 p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-red-600 rounded-lg flex justify-center items-center">
                    <!-- Kupa İkonu -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M11 15h2"/><path d="m8 20-3 1"/><path d="m16 20 3 1"/><path d="M19 19V4.5a2.5 2.5 0 0 0-5 0V13H9V4.5a2.5 2.5 0 0 0-5 0V19"/></svg>
                </div>
                <h1 class="text-xl italic font-black">ZERON <span class="text-red-600">ORG.</span></h1>
            </div>
            <div class="text-xs text-neutral-400 border border-neutral-700 p-2 rounded-full flex items-center space-x-1">
                 <!-- Saat İkonu -->
                 <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                 <span>SIFIRLANMAYA: <span id="countdown-timer" class="text-white font-bold">--:--:--</span></span>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 pt-8">
        
        <!-- BAŞARILI BİLDİRİMİ -->
        <div id="success-message" class="hidden mb-5 p-4 bg-green-900/30 border border-green-700/50 rounded-xl flex items-center space-x-3">
             <!-- Tik İkonu -->
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
             <div>
               <h3 class="m-0 text-green-400 text-lg font-semibold">Kayıt Başarılı!</h3>
               <p class="m-0 text-sm text-neutral-300">Slot <span id="booked-slot-number" class="font-bold">--</span> sizin takıma ayrıldı.</p>
             </div>
        </div>

        <!-- BİLGİ KUTUSU -->
        <div class="mb-5 p-3 bg-neutral-900 border border-neutral-800 rounded-lg text-xs text-neutral-500 flex space-x-2 items-center">
           <!-- Uyarı İkonu -->
           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
           <p class="m-0">Her takım günde sadece <strong>1 SLOT</strong> alabilir. Slotlar gece 00:00'da sıfırlanır.</p>
        </div>

        <!-- SLOT LİSTESİ -->
        <div id="slots-container" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-3">
            <!-- Slotlar JavaScript ile buraya çizilecek -->
            <div class="h-24 bg-neutral-900 rounded-xl flex items-center justify-center text-neutral-500">Yükleniyor...</div>
        </div>
    </main>

    <!-- KAYIT EKRANI (MODAL) -->
    <div id="booking-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-neutral-900 w-full max-w-sm rounded-xl overflow-hidden border border-neutral-800 shadow-2xl">
            
            <div class="bg-red-700 p-4 flex justify-between items-center">
                <h3 id="modal-title" class="m-0 font-bold text-white text-lg">SLOT ALINIYOR</h3>
                <button id="close-modal-button" class="text-white text-2xl leading-none hover:text-red-200 transition">&times;</button>
            </div>

            <form id="modal-form" class="p-5 flex flex-col space-y-4">
                <div>
                    <label class="text-xs text-neutral-500 font-bold block mb-1 tracking-wider">TAKIM İSMİ</label>
                    <div class="relative">
                        <!-- Kullanıcı İkonu -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-500 absolute left-3 top-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <input id="team-name-input" type="text" placeholder="TAKIM ADI" required maxlength="15" class="w-full bg-neutral-950 border border-neutral-700 text-white p-3 pl-10 rounded-lg outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 text-sm" />
                    </div>
                </div>
                
                <div>
                    <label class="text-xs text-neutral-500 font-bold block mb-1 tracking-wider">INSTAGRAM</label>
                    <div class="relative">
                        <!-- Instagram İkonu -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-500 absolute left-3 top-3"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                        <input id="instagram-input" type="text" placeholder="kullaniciadi" required class="w-full bg-neutral-950 border border-neutral-700 text-white p-3 pl-10 rounded-lg outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 text-sm" />
                    </div>
                </div>

                <button id="submit-button" type="submit" class="mt-4 bg-white text-black p-3 rounded-lg font-bold text-base hover:bg-neutral-200 transition disabled:bg-neutral-700 disabled:text-neutral-400">
                    SLOTU KAPAT
                </button>
            </form>

        </div>
    </div>

</body>
</html>